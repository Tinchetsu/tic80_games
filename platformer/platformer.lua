-- title:  Platformer
-- author: @tinchetsu
-- desc:   WIP platformer
-- script: lua

cam={x=0,y=0}


function camera(x,y)
	cam.x=x-120 cam.y=y
	if cam.x <0then cam.x=0 end
end

function Player(x,y)
	local player={
		x=x,y=y,w=7,h=7,dx=0,dy=0,sp=1,yinc=0.1,jmp=2,s=256,
		st=0 -- 0:ground, 1:jump
	}
	function player:update()
		local p=self
		-- handle inputs
		if btn(2) and not btn(3)then
		end
		p.dx=btn(2) and -p.sp or btn(3) and p.sp or 0
		p.dy=p.dy+p.yinc
		
		if p.dy>4 then p.dy=4 end

		moveInMap(p)
		--check state
		if isSolid(p.x,p.y+p.h+1)or isSolid(p.x+p.w,p.y+p.h+1)then
			p.st=0
		else
			p.st=1
		end
		if btn(5) and p.st==0 then
			p.st=1
			p.dy=-p.jmp
		end	
		camera(p.x,0)
	end
	function player:draw()
		local p=self
		spr(p.s,p.x-cam.x,p.y-cam.y,0)
		--draw bbox points
		--pix(p.x-cam.x,p.y-cam.y,15)
		--pix(p.x+p.w-cam.x,p.y-cam.y,15)
		--pix(p.x+p.w-cam.x,p.y+p.h-cam.y,15)
		--pix(p.x-cam.x,p.y+p.h-cam.y,15)
	end

	return player
end


function isSolid(x,y)
	return mget(x/8,y/8)~=0
end

function moveInMap(e)
	-- move and check x
	e.x=e.x+e.dx
	if e.dx>0then
		if isSolid(e.x+e.w,e.y)or isSolid(e.x+e.w,e.y+e.h)then
			e.x=((e.x+e.w)//8)*8-e.w-1
			e.dx=0
		end
	elseif e.dx<0then
		if isSolid(e.x,e.y)or isSolid(e.x,e.y+e.h)then
			e.x=((e.x//8))*8+e.w+1
		end
	end
	-- move and check y
	e.y=e.y+e.dy
	if e.dy>0then
		if isSolid(e.x,e.y+e.h) or isSolid(e.x+e.w,e.y+e.h)then
			e.y=((e.y+e.h)//8)*8-e.h-1
			e.dy=0
		end
	elseif e.dy<0then
		if isSolid(e.x,e.y) or isSolid(e.x+e.w,e.y)then
			e.y=((e.y//8))*8+e.h+1
			e.dy=0
		end
	end
end

pl=Player(100,10)

function TIC()	
	cls(0)
	map(cam.x//8,cam.y//8,31,18,8*(cam.x//8)-cam.x,8*(cam.y//8)-cam.y,0)
	pl:update()
	pl:draw()
	--print("cam["..cam.x.." "..cam.y.."]",0,0)
end

-- <TILES>
-- 001:0666666666555555655333336533332365333333653323336533333365333323
-- 002:6666666655555555333333333333332332332333333333233323333333332333
-- 003:6666666055555566333335563232335633333356333323563323335633333356
-- 004:0666666666555555655333336532333365333323655323336655555506666666
-- 005:6666666655555555332333333333332333232333233333235555555566666666
-- 006:6666666055555566333335563233235633333356233235565555556666666660
-- 007:0666666066555566655335566533335665333356653233566533335665333256
-- 008:6533335665333356653323566533335665323356653333566533235665233356
-- 009:6533325665233356653333566532335665333356655325566655556606666660
-- 010:0666666066555566655335566532335665333356655325566655556606666660
-- 017:6533333365332333653333236533333365332333653333336523332365333333
-- 018:3333333333333233332333232333333333323333323333233333333333332333
-- 019:3333335623333356333323563233335633333356333333563323335633332356
-- 033:6533333365323332653333336533323365333333655333236655555506666666
-- 034:3332333333333233323333333333333333323323333333335555555566666666
-- 035:3333235633333356332333563333335633233356233335565555556666666660
-- </TILES>

-- <SPRITES>
-- 000:7777777777777777777777777777777777777777777777777777777777777777
-- 001:0022220000242400202222022222222200022000002222000020020000200200
-- </SPRITES>

-- <MAP>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0a0a0a0a0a0a000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:800000000000000000000040505050600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:800000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:800000000000000000000000000000000000000000000000008000000000000000000000000000000000102030405060405060102030000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:800000000000001020202020300000000000000000000000008000000000000000000000000000000000112131000000000000112131000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:8000000000000012222222223200004050600000000000000090000000000000000000a000a000a00000122232000000000000122232000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:800000000000000000000000000000000000000000000040505050600000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:102020202030202020202020202020202020202020304050505050505060405050505050505050505050505050505050505050505050505050505050505050505050505060900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <PALETTE>
-- 000:1010145d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

-- <PALETTE1>
-- 000:0000007e25531d2b535f574fab5236008751ff004d83769cff77a8ffa300c2c3c700e756ffccaa29adfffff024ffffff
-- </PALETTE1>

