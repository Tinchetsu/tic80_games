-- title:  Platformer
-- author: @tinchetsu
-- desc:   WIP platformer
-- script: lua

cam={x=0,y=0}

--player states
JMP=1
WLK=2
SHT=4

Entities={}

function Entities:update()
	for i=#self,1,-1 do
		local e=self[i]
		e:update();
		-- your code here
		if not e.alive then
			self[i]=self[#self]
			self[#self] = nil
		end
	end
end

function Entities:draw()
	for _,e in ipairs(self) do
		e:draw()
	end	
end

function bin(n)
    local t = {}
    for i = 1, 32 do
		table.insert(t, 1,n&1)
		n=n>>1
    end
    return table.concat(t)
end

function camera(x,y)
	cam.x=x-120 cam.y=y
	if cam.x <0then cam.x=0 end
end

function isSolid(x,y)
	return fget(mget(x/8,y/8),0)
end

function moveInMap(e)
	-- move and check x
	e.x=e.x+e.dx
	if e.dx>0then
		if isSolid(e.x+e.w,e.y)or isSolid(e.x+e.w,e.y+e.h)then
			e.x=((e.x+e.w)//8)*8-e.w-1
			e.dx=0
		end
	elseif e.dx<0then
		if isSolid(e.x,e.y)or isSolid(e.x,e.y+e.h)then
			e.x=((e.x//8))*8+8
		end
	end
	-- move and check y
	e.y=e.y+e.dy
	if e.dy>0then
		if isSolid(e.x,e.y+e.h) or isSolid(e.x+e.w,e.y+e.h)then
			e.y=((e.y+e.h)//8)*8-e.h-1
			e.dy=0
		end
	elseif e.dy<0then
		if isSolid(e.x,e.y) or isSolid(e.x+e.w,e.y)then
			e.y=((e.y//8))*8+e.h+1
			e.dy=0
		end
	end
end

function explosion(x,y,size)
	local e={x=x,y=y,s=size,t=8,alive=true}
	function e:update()
		local s=self
		s.t=s.t-1
		s.alive=s.t>=0
	end
	function e:draw()
		local s=self
		local x,y=s.x-cam.x,s.y-cam.y
		circ(x,y,1+s.t*s.s/8,6)
		circ(x,y,s.t*s.s/8,14)
	end
	table.insert(Entities,e)
end

function pShoot(x,y,dir,type)
	local sht={x=x,y=y,dir=dir,type=type,sp=1.5,t=30,alive=true}
	sht.sp=dir>0 and sht.sp*-1 or sht.sp
	function sht:update()
		local s=self
		s.x=s.x+s.sp
		s.t=s.t-1
		if isSolid(s.x+3,s.y+5) then
			s.alive=false
			explosion(s.x+4,s.y+5,3)
			return
		end
		s.alive=s.t>0
	end
	function sht:draw()
		local s=self
		spr(276,s.x-cam.x,s.y-cam.y,0)
	end
	if type==1 then
		table.insert(Entities, sht)
	end
end

function Player(x,y)
	local player={
		x=x,y=y,w=3,h=7,oy=0,dx=0,dy=0,sp=0.6,yinc=0.08,jmp=1.8,s=372,t=0,dir=0,
		st=0, -- 0:ground, 1:jump
		a=1,
		an={256,257,258,257},
		sht=0 --shoot time
	}

	function player:update()
		local p=self
		-- handle inputs
		p.dx=0
		if btn(2) and not btn(3)then
			p.dx=-p.sp p.dir=1
		end
		if btn(3) and not btn(2)then
			p.dx=p.sp p.dir=0
		end

		p.dy=p.dy+p.yinc
		if p.dy>4 then p.dy=4 end

		moveInMap(p)
		--check state
		if isSolid(p.x,p.y+p.h+1)or isSolid(p.x+p.w,p.y+p.h+1)then
			p.st=p.st&~JMP
		else
			p.st=p.st|JMP
		end
		--jump
		if btn(5) and p.st&JMP~=JMP then
			p.st=p.st|JMP
			p.dy=-p.jmp
		end
		--shoot
		p.sht=p.sht>0 and p.sht-1 or 0
		if btn(4) then
			if p.sht==0 then
				p.sht=15
				pShoot(p.x-1,p.y,p.dir,1)
			end
		end
		if p.sht<=5 then
			p.st=p.st&~SHT
		else
			p.st=p.st|SHT
		end
		--animations
		if p.st&JMP~=JMP then
			if p.dx~=0 then
				if p.t%6==0 then
					p.a=p.a<4 and p.a+1 or 1
					p.oy=p.a%2~=0 and -1 or 0
				end
				p.s=p.an[p.a]
				p.t=p.t+1
			else
				p.s=p.an[2]
				p.oy=0
			end
		else
			p.s=259
			p.t=0
		end

		camera(p.x,0)
	end
	function player:draw()
		local p=self
		local x,y,s=math.floor(p.x-cam.x),math.floor(p.y-cam.y),p.s
		if p.st&SHT==SHT then s=s+16 end
		spr(s,x-2,y,0,1,p.dir)
		spr(260,x-2,y-8,0,1,p.dir)
		--draw bbox points
		--pix(p.x-cam.x,p.y-cam.y,12)
		--pix(p.x+p.w-cam.x,p.y-cam.y,12)
		--pix(p.x+p.w-cam.x,p.y+p.h-cam.y,12)
		--pix(p.x-cam.x,p.y+p.h-cam.y,12)
	end
	return player
end

pl=Player(16,120)


local test = {}
function test:update()
	trace("update")
end
	
function TIC()	
	cls(2)
	map(cam.x//8,cam.y//8,31,18,8*(cam.x//8)-cam.x,8*(cam.y//8)-cam.y,0)
	pl:update()
	
	Entities:update()
	
	Entities:draw()
	pl:draw()

	--print(bin(pl.st),0,10,12)
	--print(pl.sht,0,20,12)
	--print(pl.s,0,30,12)
	--print("cam["..cam.x.." "..cam.y.."]",0,0)
end

-- <TILES>
-- 001:0555555555bbbbbb5bb444445b4444945b4444445b4494445b4444445b444494
-- 002:55555555bbbbbbbb444444444444449449449444444444944494444444449444
-- 003:55555550bbbbbb5544444bb5494944b5444444b5444494b5449444b5444444b5
-- 004:0555555555bbbbbb5bb444445b4944445b4444945bb4944455bbbbbb05555555
-- 005:55555555bbbbbbbb44944444444444944494944494444494bbbbbbbb55555555
-- 006:55555550bbbbbb5544444bb5494494b5444444b594494bb5bbbbbb5555555550
-- 007:0555555055bbbb555bb44bb55b4444b55b4444b55b4944b55b4444b55b4449b5
-- 008:5b4444b55b4444b55b4494b55b4444b55b4944b55b4444b55b4494b55b9444b5
-- 009:5b4449b55b9444b55b4444b55b4944b55b4444b55bb49bb555bbbb5505555550
-- 010:0555555055bbbb555bb44bb55b4944b55b4444b55bb49bb555bbbb5505555550
-- 017:5b4444445b4494445b4444945b4444445b4494445b4444445b9444945b444444
-- 018:4444444444444944449444949444444444494444494444944444444444449444
-- 019:444444b5944444b5444494b5494444b5444444b5444444b5449444b5444494b5
-- 020:00000000000000000000000000000000000550000005b500005bb65005b6bbb5
-- 021:000000000000000000000000000000000065500005bb6560056bbb505bbbbbb5
-- 022:000000000000000000055000005b650005bbbb50056bb6500055550000055000
-- 033:5b4444445b4944495b4444445b4449445b4444445bb4449455bbbbbb05555555
-- 034:444944444444494449444444444444444449449444444444bbbbbbbb55555555
-- 035:444494b5444444b5449444b5444444b5449444b594444bb5bbbbbb5555555550
-- </TILES>

-- <TILES1>
-- 001:0666666666555555655333336533332365333333653323336533333365333323
-- 002:6666666655555555333333333333332332332333333333233323333333332333
-- 003:6666666055555566333335563232335633333356333323563323335633333356
-- 004:0666666666555555655333336532333365333323655323336655555506666666
-- 005:6666666655555555332333333333332333232333233333235555555566666666
-- 006:6666666055555566333335563233235633333356233235565555556666666660
-- 007:0666666066555566655335566533335665333356653233566533335665333256
-- 008:6533335665333356653323566533335665323356653333566533235665233356
-- 009:6533325665233356653333566532335665333356655325566655556606666660
-- 010:0666666066555566655335566532335665333356655325566655556606666660
-- 017:6533333365332333653333236533333365332333653333336523332365333333
-- 018:3333333333333233332333232333333333323333323333233333333333332333
-- 019:3333335623333356333323563233335633333356333333563323335633332356
-- 020:0000000000000000000000000000000000066000000656000065526006525556
-- 021:0000000000000000000000000000000000266000065526200625556065555556
-- 022:0000000000000000000660000065260006555560062552600066660000066000
-- 033:6533333365323332653333336533323365333333655333236655555506666666
-- 034:3332333333333233323333333333333333323323333333335555555566666666
-- 035:3333235633333356332333563333335633233356233335565555556666666660
-- </TILES1>

-- <TILES2>
-- 001:0666666666555555655333336533332365333333653323336533333365333323
-- 002:6666666655555555333333333333332332332333333333233323333333332333
-- 003:6666666055555566333335563232335633333356333323563323335633333356
-- 004:0666666666555555655333336532333365333323655323336655555506666666
-- 005:6666666655555555332333333333332333232333233333235555555566666666
-- 006:6666666055555566333335563233235633333356233235565555556666666660
-- 007:0666666066555566655335566533335665333356653233566533335665333256
-- 008:6533335665333356653323566533335665323356653333566533235665233356
-- 009:6533325665233356653333566532335665333356655325566655556606666660
-- 010:0666666066555566655335566532335665333356655325566655556606666660
-- 017:6533333365332333653333236533333365332333653333336523332365333333
-- 018:3333333333333233332333232333333333323333323333233333333333332333
-- 019:3333335623333356333323563233335633333356333333563323335633332356
-- 020:0000000000000000000000000000000000066000000656000065526006525556
-- 021:0000000000000000000000000000000000266000065526200625556065555556
-- 022:0000000000000000000660000065260006555560062552600066660000066000
-- 033:6533333365323332653333336533323365333333655333236655555506666666
-- 034:3332333333333233323333333333333333323323333333335555555566666666
-- 035:3333235633333356332333563333335633233356233335565555556666666660
-- </TILES2>

-- <TILES3>
-- 001:0555555555bbbbbb5bb444445b4444945b4444445b4494445b4444445b444494
-- 002:55555555bbbbbbbb444444444444449449449444444444944494444444449444
-- 003:55555550bbbbbb5544444bb5494944b5444444b5444494b5449444b5444444b5
-- 004:0555555555bbbbbb5bb444445b4344445b4444345bb4344455bbbbbb05555555
-- 005:55555555bbbbbbbb44344444444444344434344434444434bbbbbbbb55555555
-- 006:55555550bbbbbb5544444bb5434434b5444444b534434bb5bbbbbb5555555550
-- 007:0555555055bbbb555bb44bb55b4444b55b4444b55b4344b55b4444b55b4443b5
-- 008:5b4444b55b4444b55b4434b55b4444b55b4344b55b4444b55b4434b55b3444b5
-- 009:6544435665344456654444566543445665444456655435566655556606666660
-- 010:0666666066555566655445566543445665444456655435566655556606666660
-- 017:5b4444445b4494445b4444945b4444445b4494445b4444445b9444945b444444
-- 018:4444444444444944449444949444444444494444494444944444444444449444
-- 019:444444b5944444b5444494b5494444b5444444b5444444b5449444b5444494b5
-- 020:0000000000000000000000000000000000066000000656000065526006525556
-- 021:0000000000000000000000000000000000266000065526200625556065555556
-- 022:0000000000000000000660000065260006555560062552600066660000066000
-- 033:5b4444445b4944495b4444445b4449445b4444445bb4449455bbbbbb05555555
-- 034:444944444444494449444444444444444449449444444444bbbbbbbb55555555
-- 035:444494b5444444b5449444b5444444b5449444b594444bb5bbbbbb5555555550
-- </TILES3>

-- <SPRITES>
-- 000:00343000066666606bbbbb00bbc2c2000bcccc00006646000c6666c000300300
-- 001:00343000066666606bbbbb00bbc2c2000bcccc000066460006c66c0000033000
-- 002:00343000066666606bbbbb00bbc2c2000bcccc0000664600066c660000300300
-- 003:00343000066666606bbbbb00bbc2c2000bcccc00006646000c6666c000303000
-- 004:0000000000000000000000000000000000000000000000000060000000660000
-- 016:00343000066666606bbbbb00bbc2c2000bcccc00006646c30c66660000300300
-- 017:00343000066666606bbbbb00bbc2c2000bcccc00006646c306c6660000033000
-- 018:00343000066666606bbbbb00bbc2c2000bcccc00006646c3066c660000300300
-- 019:00343000066666606bbbbb00bbc2c2000bcccc00006646c30c66660000303000
-- 020:0000000000000000000000000000000000060000006e60000006000000000000
-- </SPRITES>

-- <SPRITES1>
-- 000:003e3000022222202666660066c8c80006cccc000022e2000c2222c000300300
-- 001:003e3000022222202666660066c8c80006cccc000022e20002c22c0000033000
-- 002:003e3000022222202666660066c8c80006cccc000022e200022c220000300300
-- 003:003e3000022222202666660066c8c80006cccc000022e2000c2222c000303000
-- 004:0000000000000000000000000000000000000000000000000020000000220000
-- 016:003e3000022222202666660066c8c80006cccc000022e2c40c22220000300300
-- 017:003e3000022222202666660066c8c80006cccc000022e2c402c2220000033000
-- 018:003e3000022222202666660066c8c80006cccc000022e2c4022c220000300300
-- 019:003e3000022222202666660066c8c80006cccc000022e2c40c22220000303000
-- </SPRITES1>

-- <SPRITES2>
-- 000:00343000022222202666660066c8c80006cccc00002242000c2222c000300300
-- 001:00343000022222202666660066c8c80006cccc000022420002c22c0000033000
-- 002:00343000022222202666660066c8c80006cccc0000224200022c220000300300
-- 003:00343000022222202666660066c8c80006cccc00002242000c2222c000303000
-- 004:0000000000000000000000000000000000000000000000000020000000220000
-- 016:00343000022222202666660066c8c80006cccc00002242c30c22220000300300
-- 017:00343000022222202666660066c8c80006cccc00002242c302c2220000033000
-- 018:00343000022222202666660066c8c80006cccc00002242c3022c220000300300
-- 019:00343000022222202666660066c8c80006cccc00002242c30c22220000303000
-- </SPRITES2>

-- <MAP>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0a0a0a0a0a0a000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:800000000000000000000000000000000000000000000000000000000000006100000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:800000000000000000000000000000000000000000000000000000000000102030004050505050505060000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:800000000000000000000000000000000000000000000000000000000000112131000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:800000000000000000000000000000000000000000000000000000a00000122232000000000000000000102030405060405060102030000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:800000000000006100410000006100000000000000000000410000000000000000000000000000000000112131000000000000112131000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:8000000000000040506000004050600000000000000040505060000000000000000000a000a000a00000122232000000000000122232000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:800000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:900000005100700000000051000000610070008000410000000000000000006100005100005100000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:102020202030202020202020202020202020202020300000000040505060405050505050505050505050505050505050505050505050505050505050505050505050505060900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <FLAGS>
-- 000:00101010101010101010100000000000001010100000000000000000000000000010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:0000007e25531d2b535f574fab5236008751ff004d83769cff77a8ffa300c2c3c700e756ffccaa29adfffff024fff1e8
-- </PALETTE>

-- <PALETTE1>
-- 000:0000007e2553ff004dffa300ab523600e75604875183769c1d2b535f574fc2c3c7ff77a8ffccaa29adfffff024ffffff
-- </PALETTE1>

-- <PALETTE2>
-- 000:1010145d275dff3e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE2>

-- <PALETTE3>
-- 000:0000007e25531d2b535f574fab5236008751ff004d83769cff77a8ffa300c2c3c700e756ffccaa29adfffff024fff1e8
-- </PALETTE3>

